# practice_go

golang の勉強用

### 翻訳後

```
チャット例
このアプリケーションは、websocket パッケージを使用して、簡単な Web チャットアプリケーションを実装する方法を示します。

サンプルを実行する
この例では、動作するGoの開発環境が必要です。入門のページでは、開発環境のインストール方法について説明しています。

Goを起動したら、以下のコマンドでサンプルをダウンロード、ビルド、実行することができます。

$ go get github.com/gorilla/websocket
$ cd `go list -f '{{.Dir}}' github.com/gorilla/websocket/examples/chat`
$ go run *.go
チャットのサンプルを使用するには、ブラウザで http://localhost:8080/ を開いてください。

サーバー
サーバーアプリケーションでは、ClientとHubの2つのタイプが定義されています。サーバーは、各ウェブソケット接続に対して Client タイプのインスタンスを作成します。Client は、ウェブソケット接続と Hub タイプの単一のインスタンスとの間の仲介役として機能します。Hub は登録されたクライアントのセットを維持し、クライアントにメッセージをブロードキャストします。

アプリケーションは、Hubに対して1つのゴルーチンを実行し、各Clientに対して2つのゴルーチンを実行します。ゴルーチンはチャネルを使用して互いに通信します。Hubは、クライアントの登録、クライアントの登録解除、メッセージのブロードキャストのためのチャネルを持っています。クライアントは、送信メッセージのバッファリングされたチャンネルを持っています。クライアントのゴルーチンの一つは、このチャンネルからメッセージを読み込み、ウェブソケットにメッセージを書き込みます。もう一方のクライアントのゴルーチンは、ウェブソケットからメッセージを読み取り、ハブに送信します。

ハブ
Hub型のコードはhub.goにあります。アプリケーションのmain関数がgoroutineとしてhubのrunメソッドを起動します。クライアントは、register, unregister, broadcast チャンネルを使用してハブにリクエストを送信します。

ハブは、クライアントポインタをクライアントマップのキーとして追加することでクライアントを登録する。マップの値は常に真である。

登録解除のコードは少し複雑です。クライアントマップからクライアントポインタを削除するだけでなく、ハブはクライアントの送信チャネルを閉じて、もうクライアントにメッセージを送信しないことを通知します。

ハブは、登録されたクライアントをループしてメッセージを処理し、クライアントの送信チャネルにメッセージを送信します。クライアントの送信バッファが一杯になった場合、ハブはそのクライアントが死んだか動かなくなったと見なします。この場合、ハブはクライアントの登録を解除し、ウェブソケットを閉じます。

クライアント
Client型のコードはclient.goにあります。

serveWs関数は、HTTPハンドラとしてアプリケーションのメイン関数に登録されています。ハンドラは、HTTP 接続を WebSocket プロトコルにアップグレードし、クライアントを作成し、クライアントをハブに登録し、defer 文を使用してクライアントが登録解除されるようにスケジュールします。

次に、HTTPハンドラはgoroutineとしてクライアントのwritePumpメソッドを起動します。このメソッドは、クライアントの送信チャネルからウェブソケット接続にメッセージを転送します。ハブによってチャネルが閉じられるか、ウェブソケット接続への書き込みにエラーが発生すると、ライターメソッドは終了します。

最後に、HTTP ハンドラはクライアントの readPump メソッドを呼び出します。このメソッドはウェブソケットからハブにインバウンドメッセージを転送します。

WebSocket 接続は、1 つの同時読み取り装置と 1 つの同時書き込み装置をサポートしています。アプリケーションは、readPump ゴルーチンからすべての読み取りを実行し、writePump ゴルーチンからすべての書き込みを実行することによって、これらの並行性要件が満たされることを保証します。

高負荷時の効率を改善するために、writePump 関数は、送信チャネルで保留中のチャット メッセージを単一の WebSocket メッセージに合体させます。これにより、システムコールの回数が減り、ネットワーク経由で送信されるデータの量が減ります。

フロントエンド
フロントエンドのコードはhome.htmlにあります。

ドキュメントのロード時に、スクリプトはブラウザでウェブソケット機能をチェックします。ウェブソケット機能が利用可能な場合、スクリプトはサーバーへの接続を開き、サーバーからのメッセージを処理するコールバックを登録する。コールバックは、appendLog 関数を使用してチャット ログにメッセージを追加します。

ユーザーが新しいメッセージから中断することなく手動でチャットログをスクロールできるように、appendLog関数は、新しいコンテンツを追加する前にスクロール位置をチェックします。チャットログが一番下までスクロールされている場合、関数はコンテンツを追加した後、ビューに新しいコンテンツをスクロールします。そうでなければ、スクロール位置は変更されません。

フォームハンドラは、ユーザー入力をウェブソケットに書き込み、入力フィールドをクリアします。

www.DeepL.com/Translator（無料版）で翻訳しました。
```
